

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>endolas.predictors &mdash; endolas 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> endolas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rsts/endolas.html">endolas package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">endolas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>endolas.predictors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for endolas.predictors</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.unet</span> <span class="kn">import</span> <span class="n">preprocess_input</span> <span class="k">as</span> <span class="n">pre_une</span>
<span class="kn">from</span> <span class="nn">.lastengen</span> <span class="kn">import</span> <span class="n">LASTENSequence</span>
<span class="kn">from</span> <span class="nn">.infergen</span> <span class="kn">import</span> <span class="n">SegmentationInferSequence</span>
<span class="kn">from</span> <span class="nn">.infergen</span> <span class="kn">import</span> <span class="n">RegistrationInferSequence</span>
<span class="kn">from</span> <span class="nn">.closs</span> <span class="kn">import</span> <span class="n">EuclideanLoss</span>
<span class="kn">from</span> <span class="nn">.ccall</span> <span class="kn">import</span> <span class="n">ProgLogger</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">peak_local_max</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">h5_file_to_dict</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">bubblesort</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">nearest_neighbor_kernel</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">sorting_kernel</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">EndolasError</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">pdb</span> <span class="kn">import</span> <span class="n">set_trace</span>

<span class="c1"># Constants</span>
<span class="c1"># NamedTuple</span>

<div class="viewcode-block" id="debug_trace"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.debug_trace">[docs]</a><span class="k">def</span> <span class="nf">debug_trace</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;Set a tracepoint in the Python debugger that works with Qt&#39;&#39;&#39;</span>
  <span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">pyqtRemoveInputHook</span>

  <span class="kn">from</span> <span class="nn">pdb</span> <span class="kn">import</span> <span class="n">set_trace</span>
  <span class="n">pyqtRemoveInputHook</span><span class="p">()</span>
  <span class="n">set_trace</span><span class="p">()</span></div>


<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># --- Private Part of the Module ---------------------------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">_PredictorTemplate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">results_key</span><span class="p">,</span>
                 <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A private class that serves as base class for all Predictors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span> <span class="o">=</span> <span class="n">grid_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span> <span class="o">=</span> <span class="n">grid_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_file</span> <span class="o">=</span> <span class="n">load_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results_key</span> <span class="o">=</span> <span class="n">results_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span> <span class="o">=</span> <span class="n">from_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span> <span class="o">=</span> <span class="n">to_frame</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">[</span><span class="s1">&#39;progress_callback&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_callback</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">[</span><span class="s1">&#39;message_callback&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">[</span><span class="s1">&#39;cancel_callback&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be implemented in the derived class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># To be implemented in the derived class</span>
    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be implemented in the derived class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If a sequence object is present a prediction is carried out, otherwise results are loaded from file</span>
<span class="sd">            only in the interval given by from and to frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_message_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Predict &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predict &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_specific</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_message_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Load &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="n">h5_file_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The file &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist or is not a valid .h5 file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_file</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">)]</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The frame &quot;</span><span class="si">{}</span><span class="s1">&quot; or &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist in loaded data &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_file</span><span class="p">))</span>

            <span class="n">from_to_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">image_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">from_to_list</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">image_id_2_prediction</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_NetworkPredictorTemplate</span><span class="p">(</span><span class="n">_PredictorTemplate</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">result_key</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span>
                 <span class="n">network</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A private class that serves as base class for all predictors that utilize neural networks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_NetworkPredictorTemplate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span>
                                                        <span class="n">result_key</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_network</span> <span class="o">=</span> <span class="n">network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_network_callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ProgLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span><span class="p">)]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_retrieve_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The keras model contains metadata the needs to be extracted here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The file &quot;</span><span class="si">{}</span><span class="s1">&quot; could not be interpreted as h5 format.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_width</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grid_width&#39;</span><span class="p">)[()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_height</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grid_height&#39;</span><span class="p">)[()]</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;No additional metadata is present in the keras model &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_width</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_height</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The selected grid width &quot;</span><span class="si">{}</span><span class="s1">&quot; or grid height &quot;</span><span class="si">{}</span><span class="s1">&quot; does not correspond to loaded&#39;</span>
                               <span class="s1">&#39;or desired prediction. Please set accordingly!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span>
                <span class="s1">&#39;The file &quot;</span><span class="si">{}</span><span class="s1">&quot; could not be properly loaded as a keras model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The Keras model does not contain a well defined input layer.&#39;</span><span class="p">)</span>


<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># --- Public Part of the Module ----------------------------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="SegmentationPredictor"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.SegmentationPredictor">[docs]</a><span class="k">class</span> <span class="nc">SegmentationPredictor</span><span class="p">(</span><span class="n">_NetworkPredictorTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The segmentation predictor infers probability maps based on a pretrained U-Net. In the class-specific</span>
<span class="sd">        implementation of the prediction, that is _predict_specific, the returned dictionary contains predictions,</span>
<span class="sd">        that are probability maps stored as numpy arrays with the shape (image_width, image_height).</span>
<span class="sd">        The predictions are accessed with the frame specific key image_id tha is for example &#39;0&#39;. Furthermore</span>
<span class="sd">        with the keys &#39;width&#39; and &#39;height&#39; one can access the output image width and height. The keys</span>
<span class="sd">        &#39;grid_width&#39; and &#39;grid_height&#39; allow to access the grid width and grid height the image was trained on.</span>
<span class="sd">        With the key &#39;settings&#39; it is possible to access the settings that were used for this inference.</span>

<span class="sd">    :param Sequence sequence: A tensorflow.keras.utils.Sequence that is used for prediction.</span>
<span class="sd">    :param dict results: The common results dictionary to write to.</span>
<span class="sd">    :param str load_file: A path indicating where previously computed results lie.</span>
<span class="sd">    :param int from_frame: The frame to start from.</span>
<span class="sd">    :param int to_frame: The frame to end with.</span>
<span class="sd">    :param str network: A path to the file where the trained model is present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SegmentationPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="s1">&#39;laser_maps&#39;</span><span class="p">,</span>
                                                    <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Naming for the implemented class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Segmentation&quot;</span>

    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class specific implementation of the prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_metadata</span><span class="p">()</span>
        <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">image_ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_callbacks</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s2">&quot;Prediction segmentation failed! Ensure loading a well-formed network for prediction!&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_ids</span><span class="p">):</span>
                <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">index</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">width</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">height</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_width</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_height</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;segmentation_batch_box&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                        <span class="s1">&#39;segmentation_network_select&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_id_2_prediction</span></div>


<div class="viewcode-block" id="RegistrationPredictor"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.RegistrationPredictor">[docs]</a><span class="k">class</span> <span class="nc">RegistrationPredictor</span><span class="p">(</span><span class="n">_NetworkPredictorTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The registration predictor infers displacement maps based on a pretrained U-Net. In the class-specific</span>
<span class="sd">        implementation of the prediction, that is _predict_specific, the returned dictionary contains predictions,</span>
<span class="sd">        that are the displacement maps, stored as numpy arrays with the shape (image_width, image_height, 2).</span>
<span class="sd">        The predictions are accessed with the frame specific key image_id tha is for example &#39;0&#39;.</span>
<span class="sd">        The x-displacement is stored in &#39;[:, :, 0]&#39;, whereas the y-displacement can be found in &#39;[:, :, 1]&#39;.</span>
<span class="sd">        Furthermore with the keys &#39;width&#39; and &#39;height&#39; one can access the output image width and height.</span>
<span class="sd">        The keys &#39;grid_width&#39; and &#39;grid_height&#39; allow to access the grid width and grid height the image was</span>
<span class="sd">        trained on. The key &#39;fix&#39; allows to access keypoints of the fixed image.</span>
<span class="sd">        With the key &#39;settings&#39; it is possible to access the settings that were used for this inference.</span>

<span class="sd">    :param Sequence sequence: A tensorflow.keras.utils.Sequence that is used for prediction.</span>
<span class="sd">    :param dict results: The common results dictionary to write to.</span>
<span class="sd">    :param str load_file: A path indicating where previously computed results lie.</span>
<span class="sd">    :param int from_frame: The frame to start from.</span>
<span class="sd">    :param int to_frame: The frame to end with.</span>
<span class="sd">    :param str network: A path to the file where the trained model is present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RegistrationPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span>
                                                    <span class="s1">&#39;laser_displacement&#39;</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Naming for the implemented class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Registration&quot;</span>

    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class specific implementation of the prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_metadata</span><span class="p">()</span>
        <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">X</span><span class="p">,</span> <span class="n">image_ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_network_callbacks</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s2">&quot;Predicting registration failed! Ensure loading a well-formed network for prediction!&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_ids</span><span class="p">):</span>
                <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;fix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">fixed_index_2_xy</span><span class="p">)</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">width</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">height</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_width</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">grid_height</span>
        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;registration_batch_box&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                                        <span class="s1">&#39;registration_network_select&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_id_2_prediction</span></div>


<div class="viewcode-block" id="PeakfindingPredictor"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PeakfindingPredictor">[docs]</a><span class="k">class</span> <span class="nc">PeakfindingPredictor</span><span class="p">(</span><span class="n">_PredictorTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A peakfinding based on the utilities from skimage is carried out. In the class-specific</span>
<span class="sd">        implementation of the prediction, that is _predict_specific, the returned string formatted dictionary</span>
<span class="sd">        contains predictions, that are mappings from a newly assigned key &#39;peaked_key&#39; to a list of predicted</span>
<span class="sd">        y-coordinate and x-coordinate, where the order &#39;[x, y]&#39; is present. The predictions are stored as strings.</span>
<span class="sd">        With the key &#39;settings&#39; it is possible to access the settings that were used for this inference.</span>

<span class="sd">    :param dict sequence: A dictionary with probability maps.</span>
<span class="sd">    :param dict results: The common results dictionary to write to.</span>
<span class="sd">    :param str load_file: A path indicating where previously computed results lie.</span>
<span class="sd">    :param int from_frame: The frame to start from.</span>
<span class="sd">    :param int to_frame: The frame to end with.</span>
<span class="sd">    :param float laser_peaks_sigma: The standard deviation used for priorly smoothing the image.</span>
<span class="sd">    :param float laser_peaks_distance: The minimal distance that peaks should have.</span>
<span class="sd">    :param float laser_peaks_threshold: The absolute lower intensity threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">laser_peaks_sigma</span><span class="p">,</span>
                 <span class="n">laser_peaks_distance</span><span class="p">,</span> <span class="n">laser_peaks_threshold</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PeakfindingPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="s1">&#39;laser_peaks&#39;</span><span class="p">,</span>
                                                   <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_sigma</span> <span class="o">=</span> <span class="n">laser_peaks_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_distance</span> <span class="o">=</span> <span class="n">laser_peaks_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_threshold</span> <span class="o">=</span> <span class="n">laser_peaks_threshold</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Naming for the implemented class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Peakfinding&quot;</span>

    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class specific implementation of the prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">laser_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">laser_map_filtered</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">laser_map</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_sigma</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">peak_local_max</span><span class="p">(</span><span class="n">laser_map_filtered</span><span class="p">,</span>
                                        <span class="n">min_distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_distance</span><span class="p">,</span>
                                        <span class="n">threshold_abs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_threshold</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">peaked_key</span><span class="p">):</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">peaked_key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction</span><span class="p">)}</span>
            <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;peak_smoothing_box&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_sigma</span><span class="p">,</span>
                                                        <span class="s1">&#39;peak_dist_box&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_distance</span><span class="p">,</span>
                                                        <span class="s1">&#39;peak_thresh_box&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks_threshold</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">image_id_2_prediction</span></div>


<div class="viewcode-block" id="DeformationPredictor"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.DeformationPredictor">[docs]</a><span class="k">class</span> <span class="nc">DeformationPredictor</span><span class="p">(</span><span class="n">_PredictorTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The deformation predictor applies displacements to generate warped keypoint. The returned string formatted</span>
<span class="sd">        dictionary contains predictions, that are mappings from a newly assigned key &#39;warped_key&#39; to a list of predicted</span>
<span class="sd">        x-coordinate and y-coordinate, where the order &#39;[x, y]&#39; is present.</span>
<span class="sd">        With the key &#39;settings&#39; it is possible to access the settings that were used for this inference.</span>

<span class="sd">    :param dict sequence: A dictionary with displacement maps.</span>
<span class="sd">    :param dict results: The common results dictionary to write to.</span>
<span class="sd">    :param str load_file: A path indicating where previously computed results lie.</span>
<span class="sd">    :param int from_frame: The frame to start from.</span>
<span class="sd">    :param int to_frame: The frame to end with.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeformationPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span>
                                                   <span class="s1">&#39;laser_deformation&#39;</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_peaks&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_y</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Naming for the implemented class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Deformation&quot;</span>

    <span class="k">def</span> <span class="nf">_get_scale_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_maps</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_maps</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class specific implementation of the prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">disp_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">moving_keypoints_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_peaks</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span>
            <span class="n">moving_keypoints</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">moving_keypoints_string</span><span class="p">)</span>
            <span class="n">warp_xy_coords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_get_scale_factors</span><span class="p">()</span>

            <span class="n">u_x</span> <span class="o">=</span> <span class="n">disp_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">u_y</span> <span class="o">=</span> <span class="n">disp_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">moving_key</span><span class="p">,</span> <span class="n">moving_xy_coords</span> <span class="ow">in</span> <span class="n">moving_keypoints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Round here is important!</span>
                <span class="n">x_coord_moving</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">moving_xy_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_x</span><span class="p">))</span>
                <span class="n">y_coord_moving</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">moving_xy_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_y</span><span class="p">))</span>

                <span class="n">ux</span> <span class="o">=</span> <span class="n">u_x</span><span class="p">[</span><span class="n">y_coord_moving</span><span class="p">][</span><span class="n">x_coord_moving</span><span class="p">]</span>
                <span class="n">uy</span> <span class="o">=</span> <span class="n">u_y</span><span class="p">[</span><span class="n">y_coord_moving</span><span class="p">][</span><span class="n">x_coord_moving</span><span class="p">]</span>

                <span class="n">x_coord_warped</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x_coord_moving</span> <span class="o">+</span> <span class="n">ux</span><span class="p">))</span>
                <span class="n">y_coord_warped</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y_coord_moving</span> <span class="o">+</span> <span class="n">uy</span><span class="p">))</span>

                <span class="n">warp_xy_coords</span><span class="p">[</span><span class="n">moving_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_coord_warped</span><span class="p">,</span> <span class="n">y_coord_warped</span><span class="p">]</span>

            <span class="n">prediction</span> <span class="o">=</span> <span class="n">warp_xy_coords</span>
            <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">image_id_2_prediction</span></div>


<div class="viewcode-block" id="NeighborPredictor"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.NeighborPredictor">[docs]</a><span class="k">class</span> <span class="nc">NeighborPredictor</span><span class="p">(</span><span class="n">_PredictorTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The neighbor predictor carries out a nearest neighbor search.</span>
<span class="sd">        The returned string formatted dictionary contains mappings from &#39;warped_key&#39; to &#39;fixed_key&#39;.</span>
<span class="sd">        The predictions are accessed with the frame specific key image_id that is for example &#39;0&#39;.</span>
<span class="sd">        With the key &#39;settings&#39; it is possible to access the settings that were used for this inference.</span>

<span class="sd">    :param dict sequence: A dictionary with displaced keypoints.</span>
<span class="sd">    :param dict results: The common results dictionary to write to.</span>
<span class="sd">    :param str load_file: A path indicating where previously computed results lie.</span>
<span class="sd">    :param int from_frame: The frame to start from.</span>
<span class="sd">    :param int to_frame: The frame to end with.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NeighborPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span>
                                                <span class="s1">&#39;laser_nearest&#39;</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_y</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Naming for the implemented class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Neighbor&quot;</span>

    <span class="k">def</span> <span class="nf">_get_scale_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implementation to retrieve a scaling factor for the x-coordinate that is the width of the warped image</span>
<span class="sd">            space over the width of the fixed image space and a scaling factor for the y-coordinate that is the</span>
<span class="sd">            height of the warped image space over the height of the fixed image space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_maps</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_maps</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class specific implementation of the prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_scale_factors</span><span class="p">()</span>
        <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">fixed_key_2_fixed_val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;fix&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">warped_keypoints</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">warped_key_2_warped_val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">warped_keypoints</span><span class="p">)</span>
            <span class="n">warped_key_2_fixed_key</span> <span class="o">=</span> <span class="n">nearest_neighbor_kernel</span><span class="p">(</span><span class="n">warped_key_2_warped_val</span><span class="p">,</span>
                                                             <span class="n">fixed_key_2_fixed_val</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_x</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">_scale_factor_y</span><span class="p">)</span>
            <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">warped_key_2_fixed_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">image_id_2_prediction</span></div>


<div class="viewcode-block" id="SortingPredictor"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.SortingPredictor">[docs]</a><span class="k">class</span> <span class="nc">SortingPredictor</span><span class="p">(</span><span class="n">_PredictorTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The sorting predictor uses a grid logic, that is the ascending order of the keys within the grid.</span>
<span class="sd">        The returned string formatted dictionary contains mappings from &#39;warped_key&#39; to &#39;fixed_key&#39;.</span>
<span class="sd">        The predictions are accessed with the frame specific key image_id that is for example &#39;0&#39;.</span>
<span class="sd">        With the key &#39;settings&#39; it is possible to access the settings that were used for this inference.</span>

<span class="sd">    :param dict sequence: A dictionary with correspondences.</span>
<span class="sd">    :param dict results: The common results dictionary to write to.</span>
<span class="sd">    :param str load_file: A path indicating where previously computed results lie.</span>
<span class="sd">    :param int from_frame: The frame to start from.</span>
<span class="sd">    :param int to_frame: The frame to end with.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SortingPredictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">load_file</span><span class="p">,</span> <span class="s1">&#39;laser_sorted&#39;</span><span class="p">,</span>
                                               <span class="n">from_frame</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_deformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_deformation&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Naming for the implemented class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Sorting&quot;</span>

    <span class="k">def</span> <span class="nf">_predict_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Class specific implementation of the prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">grid_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]</span>
        <span class="n">grid_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_laser_displacement</span><span class="p">[</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">warped_key_2_fixed_key</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">warped_key_2_warped_val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_laser_deformation</span><span class="p">[</span><span class="n">image_id</span><span class="p">])</span>

            <span class="n">warped_key_2_fixed_key</span> <span class="o">=</span> <span class="n">sorting_kernel</span><span class="p">(</span><span class="n">warped_key_2_fixed_key</span><span class="p">,</span>
                                                    <span class="n">warped_key_2_warped_val</span><span class="p">,</span>
                                                    <span class="n">grid_width</span><span class="p">,</span>
                                                    <span class="n">grid_height</span><span class="p">)</span>

            <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">warped_key_2_fixed_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">image_id_2_prediction</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">image_id_2_prediction</span></div>


<div class="viewcode-block" id="PredictorContainer"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PredictorContainer">[docs]</a><span class="k">class</span> <span class="nc">PredictorContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This container class is composed by many predictors that are all managed within.</span>

<span class="sd">    :param ndarray data: The image data with shape (frames, width, height, 1)</span>
<span class="sd">    :param dict settings: Settings object has passed by GUI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span> <span class="o">=</span> <span class="n">grid_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span> <span class="o">=</span> <span class="n">grid_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">[</span><span class="s1">&#39;cancel_callback&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">callbacks</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
                         <span class="s1">&#39;laser_peaks&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
                         <span class="s1">&#39;laser_displacement&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
                         <span class="s1">&#39;laser_deformation&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
                         <span class="s1">&#39;laser_nearest&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>
                         <span class="s1">&#39;laser_sorted&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;from_frame&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;to_frame&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_check_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Do some checks on the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_callback</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;laser_peaks&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;laser_displacement&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;laser_deformation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;laser_nearest&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="s1">&#39;laser_sorted&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">][</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">][</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The grid widths from the trained segmentation &quot;</span><span class="si">{}</span><span class="s1">&quot; and registration &quot;</span><span class="si">{}</span><span class="s1">&quot; network &#39;</span>
                               <span class="s1">&#39;are not the same.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">][</span><span class="s1">&#39;grid_width&#39;</span><span class="p">],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">][</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">][</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">][</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">EndolasError</span><span class="p">(</span><span class="s1">&#39;The grid heights from the trained segmentation &quot;</span><span class="si">{}</span><span class="s1">&quot; and registration &quot;</span><span class="si">{}</span><span class="s1">&quot; network &#39;</span>
                               <span class="s1">&#39;are not the same.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">][</span><span class="s1">&#39;grid_height&#39;</span><span class="p">],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">][</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]))</span>

<div class="viewcode-block" id="PredictorContainer.build_predictors"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PredictorContainer.build_predictors">[docs]</a>    <span class="k">def</span> <span class="nf">build_predictors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internally registers all predictors in a common container.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">segmentation_sequence</span> <span class="o">=</span> <span class="n">SegmentationInferSequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                          <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_maps_batch&#39;</span><span class="p">])</span> \
                                                          <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_maps&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">registration_sequence</span> <span class="o">=</span> <span class="n">RegistrationInferSequence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_peaks&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">],</span>
                                                          <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_displacement_batch&#39;</span><span class="p">])</span> \
                                                          <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_displacement&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">peakfinding_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_peaks&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">deformation_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_deformation&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">neighbor_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_deformation&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_nearest&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">sorting_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_nearest&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_sorting&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SegmentationPredictor</span><span class="p">(</span><span class="n">segmentation_sequence</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_maps_file&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_maps_network&#39;</span><span class="p">],</span>
                                                      <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PeakfindingPredictor</span><span class="p">(</span><span class="n">peakfinding_sequence</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_peaks_file&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_peaks_sigma&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_peaks_distance&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_peaks_threshold&#39;</span><span class="p">],</span>
                                                     <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RegistrationPredictor</span><span class="p">(</span><span class="n">registration_sequence</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_displacement_file&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;laser_displacement_network&#39;</span><span class="p">],</span>
                                                      <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DeformationPredictor</span><span class="p">(</span><span class="n">deformation_sequence</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_deformation_file&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                     <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NeighborPredictor</span><span class="p">(</span><span class="n">neighbor_sequence</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_nearest_file&#39;</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                  <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SortingPredictor</span><span class="p">(</span><span class="n">sorting_sequence</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_grid_width</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_grid_height</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_sorting_file&#39;</span><span class="p">],</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_from_frame</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_to_frame</span><span class="p">,</span>
                                                 <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span></div>

<div class="viewcode-block" id="PredictorContainer.predict"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PredictorContainer.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Predict the results of all predictors and return result dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictors</span><span class="p">:</span>
            <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_results</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span></div>

<div class="viewcode-block" id="PredictorContainer.store_results"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PredictorContainer.store_results">[docs]</a>    <span class="k">def</span> <span class="nf">store_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Intermediate purpose only. Once package is finished, results will be handled by GUI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_maps&#39;</span><span class="p">]:</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_maps&#39;</span><span class="p">]</span>
            <span class="n">hf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;results/segmentation.h5&#39;</span><span class="p">)</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_peaks&#39;</span><span class="p">]:</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_peaks&#39;</span><span class="p">]</span>
            <span class="n">hf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;results/peaks.h5&#39;</span><span class="p">)</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_displacement&#39;</span><span class="p">]:</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_displacement&#39;</span><span class="p">]</span>
            <span class="n">hf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;results/displacement.h5&#39;</span><span class="p">)</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_deformation&#39;</span><span class="p">]:</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_deformation&#39;</span><span class="p">]</span>
            <span class="n">hf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;results/deformation.h5&#39;</span><span class="p">)</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_nearest&#39;</span><span class="p">]:</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_nearest&#39;</span><span class="p">]</span>
            <span class="n">hf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;results/neighbor.h5&#39;</span><span class="p">)</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s1">&#39;load_laser_sorting&#39;</span><span class="p">]:</span>
            <span class="n">image_id_2_prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="s1">&#39;laser_sorted&#39;</span><span class="p">]</span>
            <span class="n">hf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;results/sort.h5&#39;</span><span class="p">)</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hf_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">image_id_2_prediction</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prediction</span><span class="p">)</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="PredictorContainer.disable_gpus"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PredictorContainer.disable_gpus">[docs]</a>    <span class="k">def</span> <span class="nf">disable_gpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Disables GPUs if present and infers on CPU.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_visible_devices</span><span class="p">([],</span> <span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
        <span class="n">visible_devices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_visible_devices</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">visible_devices</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">device</span><span class="o">.</span><span class="n">device_type</span> <span class="o">!=</span> <span class="s1">&#39;GPU&#39;</span></div>

<div class="viewcode-block" id="PredictorContainer.get_results"><a class="viewcode-back" href="../../rsts/endolas.html#endolas.predictors.PredictorContainer.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Julian Zilker

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>